<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Quản lý Link Cá nhân hóa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500&family=Montserrat:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                    },
                    colors: {
                        bgDark: '#0d1117',
                        cardDark: '#161b22',
                        borderDark: '#30363d',
                        accent: '#58a6ff',
                        success: '#238636',
                        keyword: '#ff7b72',
                        func: '#d2a8ff',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0d1117;
            color: #e6edf3;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0d1117;
        }

        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #58a6ff;
        }

        .glass-panel {
            background: rgba(22, 27, 34, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(88, 166, 255, 0.2);
        }
    </style>
</head>

<body class="font-sans antialiased min-h-screen">

    <!-- Header -->
    <nav class="fixed top-0 left-0 w-full z-50 bg-bgDark/90 backdrop-blur-md border-b border-borderDark">
        <div class="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1">
                    </path>
                </svg>
                <span class="font-mono font-bold text-white">&lt;Admin_Panel /&gt;</span>
            </div>
            <a href="/" class="text-sm text-gray-400 hover:text-accent transition font-mono">← Về trang chủ</a>
        </div>
    </nav>

    <main class="pt-20 pb-12 px-4 max-w-6xl mx-auto">

        <!-- Templates Section -->
        <section class="glass-panel rounded-2xl p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-white flex items-center gap-2">
                    <svg class="w-5 h-5 text-func" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    Template Lời Chúc
                </h2>
                <button onclick="toggleTemplateForm()" id="toggleTemplateBtn"
                    class="text-sm text-accent hover:underline font-mono">+ Tạo template</button>
            </div>

            <!-- Template Form (Hidden by default) -->
            <div id="templateForm" class="hidden mb-4 p-4 bg-bgDark rounded-lg border border-borderDark">
                <div class="grid md:grid-cols-3 gap-3">
                    <input type="text" id="templateName" placeholder="Tên template (VD: Thân thiết)"
                        class="bg-cardDark border border-borderDark rounded-lg px-3 py-2 text-white text-sm focus:border-func focus:outline-none">
                    <textarea id="templateContent" rows="2" placeholder="Nội dung lời chúc..."
                        class="md:col-span-2 bg-cardDark border border-borderDark rounded-lg px-3 py-2 text-white text-sm focus:border-func focus:outline-none resize-none"></textarea>
                </div>
                <div class="flex gap-2 mt-3">
                    <button onclick="saveTemplate()"
                        class="px-4 py-2 bg-func/20 hover:bg-func/30 text-func text-sm rounded-lg transition font-medium">
                        Lưu Template
                    </button>
                    <button onclick="toggleTemplateForm()"
                        class="px-4 py-2 bg-gray-700/30 hover:bg-gray-700/50 text-gray-400 text-sm rounded-lg transition">
                        Hủy
                    </button>
                </div>
            </div>

            <!-- Saved Templates -->
            <div id="templatesList" class="flex flex-wrap gap-2">
                <span class="text-gray-500 text-sm">Đang tải templates...</span>
            </div>
        </section>

        <!-- Create Form -->
        <section class="glass-panel rounded-2xl p-6 mb-8">
            <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                <svg class="w-5 h-5 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Tạo Link Cá nhân hóa
            </h2>

            <form id="createForm" class="grid md:grid-cols-2 gap-4">
                <!-- Recipient Name -->
                <div>
                    <label class="block text-sm font-mono text-gray-400 mb-2">Tên người nhận *</label>
                    <input type="text" id="recipientName" required
                        class="w-full bg-bgDark border border-borderDark rounded-lg px-4 py-3 text-white focus:border-accent focus:outline-none transition font-medium"
                        placeholder="Nguyễn Văn A">
                </div>

                <!-- Custom Slug -->
                <div>
                    <label class="block text-sm font-mono text-gray-400 mb-2">
                        Custom URL <span class="text-gray-600">(Để trống = tự động)</span>
                    </label>
                    <div class="flex items-center bg-bgDark border border-borderDark rounded-lg overflow-hidden">
                        <span class="px-3 text-gray-500 font-mono text-sm">/p/</span>
                        <input type="text" id="customSlug"
                            class="flex-1 bg-transparent py-3 pr-4 text-white focus:outline-none"
                            placeholder="nguyen-van-a">
                    </div>
                </div>

                <!-- Message -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-mono text-gray-400 mb-2">Lời chúc *</label>
                    <textarea id="message" required rows="3"
                        class="w-full bg-bgDark border border-borderDark rounded-lg px-4 py-3 text-white focus:border-accent focus:outline-none transition resize-none"
                        placeholder="Chúc bạn luôn thành công và hạnh phúc..."></textarea>
                </div>

                <!-- Page Title -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-mono text-gray-400 mb-2">
                        Tiêu đề trang <span class="text-gray-600">(Để trống = "Thiệp mời [Tên]")</span>
                    </label>
                    <input type="text" id="pageTitle"
                        class="w-full bg-bgDark border border-borderDark rounded-lg px-4 py-3 text-white focus:border-accent focus:outline-none transition"
                        placeholder="Thiệp mời đặc biệt dành cho...">
                </div>

                <!-- Submit -->
                <div class="md:col-span-2">
                    <button type="submit"
                        class="w-full md:w-auto px-8 py-3 bg-success hover:bg-success/80 text-white font-bold rounded-lg transition flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1">
                            </path>
                        </svg>
                        Tạo Link
                    </button>
                </div>
            </form>

            <!-- Status Message -->
            <div id="statusMessage" class="mt-4 hidden"></div>
        </section>

        <!-- Links List -->
        <section class="glass-panel rounded-2xl p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                    </svg>
                    Danh sách Link
                </h2>
                <button onclick="loadLinks()" class="text-sm text-accent hover:underline font-mono">↻ Refresh</button>
            </div>

            <div id="linksList" class="space-y-3">
                <div class="text-center text-gray-500 py-8">
                    <div
                        class="animate-spin w-8 h-8 border-2 border-accent border-t-transparent rounded-full mx-auto mb-3">
                    </div>
                    Đang tải...
                </div>
            </div>
        </section>
    </main>

    <script>
        const API_BASE = window.location.origin;

        // --- TEMPLATES ---
        function toggleTemplateForm() {
            const form = document.getElementById('templateForm');
            const btn = document.getElementById('toggleTemplateBtn');
            form.classList.toggle('hidden');
            btn.textContent = form.classList.contains('hidden') ? '+ Tạo template' : '× Đóng';
        }

        async function loadTemplates() {
            const container = document.getElementById('templatesList');
            try {
                const res = await fetch(`${API_BASE}/api/templates`);
                const templates = await res.json();

                if (templates.length === 0) {
                    container.innerHTML = '<span class="text-gray-500 text-sm italic">Chưa có template. Nhấn "+ Tạo template" để thêm.</span>';
                    return;
                }

                container.innerHTML = templates.map(t => `
                    <div class="group inline-flex items-center gap-1 bg-func/10 hover:bg-func/20 border border-func/30 rounded-lg px-3 py-1.5 transition">
                        <button onclick="useTemplate('${escapeHtml(t.content.replace(/'/g, "\\'"))}')" class="text-func text-sm font-medium">
                            ${escapeHtml(t.name)}
                        </button>
                        <button onclick="deleteTemplate('${escapeHtml(t.name)}')" class="text-gray-500 hover:text-keyword text-xs ml-1 opacity-0 group-hover:opacity-100 transition">×</button>
                    </div>
                `).join('');
            } catch (err) {
                container.innerHTML = '<span class="text-keyword text-sm">Lỗi tải templates</span>';
            }
        }

        async function saveTemplate() {
            const name = document.getElementById('templateName').value.trim();
            const content = document.getElementById('templateContent').value.trim();

            if (!name || !content) {
                showStatus('error', 'Vui lòng nhập đủ tên và nội dung template');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/templates`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, content })
                });

                if (res.ok) {
                    showStatus('success', 'Đã lưu template!');
                    document.getElementById('templateName').value = '';
                    document.getElementById('templateContent').value = '';
                    toggleTemplateForm();
                    loadTemplates();
                } else {
                    const data = await res.json();
                    showStatus('error', data.error || 'Lỗi lưu template');
                }
            } catch (err) {
                showStatus('error', 'Không thể kết nối server');
            }
        }

        function useTemplate(content) {
            document.getElementById('message').value = content;
            document.getElementById('message').focus();
            showStatus('success', 'Đã áp dụng template!');
        }

        async function deleteTemplate(name) {
            if (!confirm(`Xóa template "${name}"?`)) return;
            try {
                await fetch(`${API_BASE}/api/templates/${encodeURIComponent(name)}`, { method: 'DELETE' });
                loadTemplates();
            } catch (err) { }
        }

        // --- LINKS ---
        document.addEventListener('DOMContentLoaded', () => {
            loadLinks();
            loadTemplates();
        });

        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                recipient_name: document.getElementById('recipientName').value.trim(),
                message: document.getElementById('message').value.trim(),
                slug: document.getElementById('customSlug').value.trim(),
                page_title: document.getElementById('pageTitle').value.trim()
            };

            try {
                const res = await fetch(`${API_BASE}/api/links`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (res.ok) {
                    showStatus('success', `Link đã tạo: ${API_BASE}/p/${result.link.slug}`);
                    document.getElementById('createForm').reset();
                    loadLinks();
                } else {
                    showStatus('error', result.error || 'Có lỗi xảy ra');
                }
            } catch (err) {
                showStatus('error', 'Không thể kết nối server');
            }
        });

        async function loadLinks() {
            const container = document.getElementById('linksList');
            container.innerHTML = '<div class="text-center text-gray-500 py-8"><div class="animate-spin w-8 h-8 border-2 border-accent border-t-transparent rounded-full mx-auto mb-3"></div>Đang tải...</div>';

            try {
                const res = await fetch(`${API_BASE}/api/links`);
                const links = await res.json();

                if (links.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-8 font-mono">Chưa có link nào. Tạo link đầu tiên ngay!</div>';
                    return;
                }

                container.innerHTML = links.map(link => `
                    <div class="bg-bgDark border border-borderDark rounded-lg p-4 hover:border-accent transition group">
                        <div class="flex flex-col md:flex-row md:items-center gap-3">
                            <div class="flex-1 min-w-0">
                                <div class="font-bold text-white truncate">${escapeHtml(link.recipient_name)}</div>
                                <div class="text-sm text-gray-400 truncate mt-1">${escapeHtml(link.message)}</div>
                                <div class="text-xs text-gray-600 mt-2 font-mono">/p/${link.slug}</div>
                            </div>
                            <div class="flex items-center gap-2 shrink-0">
                                <button onclick="copyLink('${link.slug}')" 
                                    class="px-4 py-2 bg-accent/10 hover:bg-accent/20 text-accent rounded-lg text-sm font-medium transition flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
                                    </svg>
                                    Copy
                                </button>
                                <a href="/p/${link.slug}" target="_blank"
                                    class="px-4 py-2 bg-success/10 hover:bg-success/20 text-success rounded-lg text-sm font-medium transition">
                                    Xem
                                </a>
                                <button onclick="deleteLink('${link.slug}')"
                                    class="px-3 py-2 bg-keyword/10 hover:bg-keyword/20 text-keyword rounded-lg text-sm transition">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                container.innerHTML = '<div class="text-center text-keyword py-8">Không thể tải danh sách links</div>';
            }
        }

        function copyLink(slug) {
            const url = `${API_BASE}/p/${slug}`;
            navigator.clipboard.writeText(url).then(() => {
                showStatus('success', 'Đã copy link vào clipboard!');
            }).catch(() => {
                prompt('Copy link:', url);
            });
        }

        async function deleteLink(slug) {
            if (!confirm(`Xác nhận xóa link: /p/${slug}?`)) return;

            try {
                const res = await fetch(`${API_BASE}/api/links/${slug}`, { method: 'DELETE' });
                if (res.ok) {
                    showStatus('success', 'Đã xóa link');
                    loadLinks();
                } else {
                    showStatus('error', 'Không thể xóa link');
                }
            } catch (err) {
                showStatus('error', 'Lỗi kết nối');
            }
        }

        function showStatus(type, message) {
            const el = document.getElementById('statusMessage');
            el.className = `mt-4 p-4 rounded-lg font-medium ${type === 'success' ? 'bg-success/10 text-success' : 'bg-keyword/10 text-keyword'}`;
            el.textContent = message;
            el.classList.remove('hidden');

            setTimeout(() => el.classList.add('hidden'), 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>